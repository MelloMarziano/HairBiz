<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Pedido - HairBiz Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #a855f7;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --dark-text: #1e293b;
            --light-text: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-text);
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 0;
            position: sticky; top: 0; z-index: 1000;
        }
        .back-btn {
            background: var(--primary-color);
            color: white; border: none; padding: 0.5rem 1rem;
            border-radius: 8px; text-decoration: none;
            display: inline-flex; align-items: center; gap: 0.5rem;
            font-weight: 500; transition: all 0.3s ease;
        }
        .back-btn:hover { background: var(--secondary-color); color: white; transform: translateY(-1px); }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--dark-text); margin: 0; }
        .card-surface {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .search-input {
            border: 2px solid var(--border-color); border-radius: 12px; padding: 0.75rem 1rem; font-size: 1rem; background: white;
        }
        .search-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); outline: none; }
        .product-card { background: white; border-radius: 12px; padding: 1rem; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 100%; }
        .product-name { font-weight: 600; }
        .qty-input { width: 90px; }
        .qty-controls button { border: 1px solid var(--border-color); background: #fff; }
        .action-btn { background: var(--primary-color); color: white; border: none; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; transition: all 0.3s ease; }
        .action-btn:hover { background: var(--secondary-color); color: white; transform: translateY(-1px); }

        @media (max-width: 768px) {
            .page-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <a href="index.html" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Volver
                    </a>
                </div>
                <div class="col">
                    <h1 class="page-title">Nuevo Pedido</h1>
                </div>
                <div class="col-auto">
                    <button id="btnGenerar" class="action-btn" onclick="generarTextoPedido()">
                        <i class="fas fa-file-alt"></i> Realizar pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <!-- Buscar producto -->
        <div class="card-surface mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control search-input border-start-0" placeholder="Buscar producto por nombre o categoría...">
            </div>
            <div class="mt-2 text-muted small" id="productosCount">0 productos</div>
        </div>

        <!-- Lista de productos -->
        <div class="card-surface">
            <div class="row" id="productosContainer">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted">Cargando productos...</p>
                </div>
            </div>
        </div>

        <!-- Resultado -->
        <div class="card-surface mt-3" id="resultadoCard" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="m-0">Texto del pedido</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="copiarTextoPedido()">
                    <i class="fas fa-copy"></i> Copiar
                </button>
            </div>
            <textarea id="textoPedido" class="form-control" rows="6" readonly></textarea>
        </div>
    </div>

    <!-- Modal de confirmación del pedido -->
    <div class="modal fade" id="resumenPedidoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resumen del Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="resumenPedido" class="mb-0" style="white-space:pre-wrap;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="copiarTextoPedido()">
                        <i class="fas fa-copy"></i> Copiar texto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAVUmZ7t3xC3_Hz5mGM4IG3PcFUi6utxDQ",
            authDomain: "hairbiz-6262f.firebaseapp.com",
            projectId: "hairbiz-6262f",
            storageBucket: "hairbiz-6262f.firebasestorage.app",
            messagingSenderId: "1061804186635",
            appId: "1:1061804186635:web:7b904658deda5852577b0e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado
        let productosData = [];
        const seleccion = new Map(); // id -> { nombre, cantidad }

        async function cargarProductos() {
            const cont = document.getElementById('productosContainer');
            try {
                let prods = [];
                // Intentar traer activos con orden por nombre; si falta índice, fallback
                try {
                    const q = query(collection(db, 'productos'), where('estado', '==', 'activo'), orderBy('nombre'));
                    const snap = await getDocs(q);
                    snap.forEach(d => prods.push({ id: d.id, ...d.data() }));
                } catch (e) {
                    const snap2 = await getDocs(collection(db, 'productos'));
                    snap2.forEach(d => prods.push({ id: d.id, ...d.data() }));
                    prods = prods.filter(p => (p.estado || 'activo') === 'activo').sort((a,b) => (a.nombre||'').localeCompare(b.nombre||''));
                }

                productosData = prods;
                renderProductos(prods);
            } catch (error) {
                cont.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning">Error al cargar productos</h5>
                        <p class="text-muted">Por favor, intenta recargar la página.</p>
                    </div>
                `;
            }
        }

        function renderProductos(lista) {
            const cont = document.getElementById('productosContainer');
            document.getElementById('productosCount').textContent = `${lista.length} productos`;
            if (!lista || lista.length === 0) {
                cont.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay productos activos</h5>
                    </div>
                `;
                return;
            }

            cont.innerHTML = lista.map(p => `
                <div class="col-lg-4 col-md-6 col-sm-12 mb-3">
                    <div class="product-card h-100 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="product-name">${p.nombre || 'Producto'}</div>
                                <div class="text-muted small">${p.categoria || ''}</div>
                            </div>
                            <div class="text-end">
                                ${p.precioVenta ? `<div class="fw-semibold">$${Number(p.precioVenta).toLocaleString()}</div>` : ''}
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2 mt-auto">
                            <div class="input-group qty-input">
                                <button class="btn btn-outline-secondary" type="button" onclick="window.cambiarCantidad('${p.id}', -1)"><i class="fas fa-minus"></i></button>
                                <input type="number" min="0" class="form-control text-center" id="qty-${p.id}" value="0" oninput="window.setCantidad('${p.id}', this.value)">
                                <button class="btn btn-outline-secondary" type="button" onclick="window.cambiarCantidad('${p.id}', 1)"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Búsqueda
        document.getElementById('searchInput').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const filtrados = productosData.filter(p => {
                const nombre = (p.nombre || '').toLowerCase();
                const categoria = (p.categoria || '').toLowerCase();
                return nombre.includes(term) || categoria.includes(term);
            });
            renderProductos(filtrados);
        });

        // Manejo de cantidades
        window.cambiarCantidad = function(id, delta) {
            const input = document.getElementById(`qty-${id}`);
            if (!input) return;
            let val = parseInt(input.value) || 0;
            val = Math.max(0, val + delta);
            input.value = val;
            window.setCantidad(id, val);
        };
        window.setCantidad = function(id, cantidad) {
            cantidad = parseInt(cantidad) || 0;
            const prod = productosData.find(p => p.id === id);
            if (!prod) return;
            if (cantidad > 0) {
                seleccion.set(id, { nombre: prod.nombre || 'Producto', cantidad });
            } else {
                seleccion.delete(id);
            }
        };

        // Generar texto de pedido
        window.generarTextoPedido = function() {
            if (seleccion.size === 0) {
                alert('Selecciona cantidades para al menos un producto');
                return;
            }
            let texto = 'Quiero un nuevo pedido:\n';
            seleccion.forEach(item => {
                const sufijo = (item.cantidad === 1) ? '(producto)' : '(productos)';
                texto += `* ${item.nombre}: ${item.cantidad} ${sufijo}\n`;
            });
            texto += '\nMuchas gracias.';

            const textarea = document.getElementById('textoPedido');
            textarea.value = texto;
            document.getElementById('resultadoCard').style.display = 'block';

            const pre = document.getElementById('resumenPedido');
            pre.textContent = texto;
            const modal = new bootstrap.Modal(document.getElementById('resumenPedidoModal'));
            modal.show();
        };

        window.copiarTextoPedido = async function() {
            const texto = document.getElementById('textoPedido').value || document.getElementById('resumenPedido').textContent;
            try {
                await navigator.clipboard.writeText(texto);
                alert('Texto copiado al portapapeles');
            } catch (e) {
                console.error('Error al copiar texto', e);
                alert('No se pudo copiar el texto');
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', cargarProductos);
    </script>
</body>
</html>